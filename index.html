<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karlia | Exclusive Menu</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;1,600&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #d4af37;
            --gold-hover: #f1c40f;
            --dark-glass: rgba(0, 0, 0, 0.75);
            --light-glass: rgba(255, 255, 255, 0.05);
            --border-color: rgba(212, 175, 55, 0.3);
            --danger: #c0392b;
            --warning: #e67e22;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            color: #eee; 
            min-height: 100vh; 
            padding: 20px;
            background: url('Background.jpg') no-repeat center center fixed; 
            background-size: cover;
        }

        .container { max-width: 1100px; margin: 0 auto; }

        header { text-align: center; padding: 50px 0; }
        header h1 { 
            font-family: 'Playfair Display', serif; 
            font-size: 3.5rem; 
            margin-bottom: 10px; 
            color: var(--gold);
            text-shadow: 2px 2px 15px rgba(0,0,0,0.8);
            letter-spacing: 2px;
        }
        header p { 
            font-weight: 400; 
            letter-spacing: 1px; 
            color: #fff; 
            text-shadow: 1px 1px 5px rgba(0,0,0,0.8);
        }
        
        .sync-status { 
            display: inline-flex; align-items: center; margin-top: 15px;
            background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 50px; 
            font-size: 0.75rem; border: 1px solid var(--border-color); color: var(--gold);
            cursor: pointer;
        }
        .sync-status:hover { background: rgba(0,0,0,0.9); }
        .dot { height: 6px; width: 6px; background-color: var(--gold); border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite; }
        .dot.syncing { animation: spin 1s linear infinite; background-color: #fff; }
        .dot.error { background-color: var(--danger); animation: none; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .last-updated {
            text-align: center;
            font-size: 0.7rem;
            color: #888;
            margin-top: 5px;
        }

        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; margin-top: 40px; }
        
        .menu-item { 
            background: var(--dark-glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 16px; 
            overflow: hidden; 
            display: flex; flex-direction: column; 
            transition: transform 0.3s, box-shadow 0.3s; 
        }
        .menu-item:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.6);
            border-color: var(--gold);
        }
        .menu-item.out-of-stock {
            opacity: 0.6;
            filter: grayscale(0.5);
        }
        
        .item-image { width: 100%; height: 220px; background: #222; position: relative; }
        .item-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        
        .discount-badge { position: absolute; top: 15px; right: 15px; background: #c0392b; color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600; font-size: 0.8rem; z-index: 2; }
        .stock-badge { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.85); color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.2); z-index: 2; }
        .stock-badge.low { background: rgba(192, 57, 43, 0.9); }

        .item-content { padding: 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .item-name { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: #fff; margin-bottom: 8px; }
        .item-desc { font-size: 0.9rem; color: #ccc; margin-bottom: 20px; line-height: 1.6; flex-grow: 1; }
        
        .price-row { display: flex; align-items: baseline; gap: 10px; margin-bottom: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .now-price { font-size: 1.5rem; font-weight: 600; color: var(--gold); }

        .qty-box { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 8px; }
        .qty-btn { width: 35px; height: 35px; border: none; background: transparent; color: #fff; cursor: pointer; font-size: 1.2rem; }
        
        .buy-btn { 
            width: 100%; padding: 15px; border: none; border-radius: 8px; 
            background: linear-gradient(135deg, var(--gold) 0%, #b8860b 100%); 
            color: #000; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;
            cursor: pointer; transition: 0.3s; 
        }
        .buy-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .buy-btn:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
            filter: none;
        }

        .name-field { margin-top: 20px; }
        .name-field label { display: block; color: var(--gold); font-size: 0.8rem; margin-bottom: 8px; text-transform: uppercase; }
        .name-field input { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); 
            background: rgba(0,0,0,0.5); color: #fff; outline: none; transition: 0.3s; 
        }
        .name-field input:focus { border-color: var(--gold); background: rgba(0,0,0,0.7); }

        .cart-trigger { 
            position: fixed; bottom: 30px; right: 30px; 
            width: 70px; height: 70px; 
            background: #111; border: 2px solid var(--gold);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 1.8rem; cursor: pointer; z-index: 100; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: transform 0.3s;
        }
        .cart-trigger:hover { transform: scale(1.1); }
        .count-pill { position: absolute; top: 0; right: 0; background: #c0392b; color: #fff; min-width: 24px; height: 24px; border-radius: 50%; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; border: 2px solid #111; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal.open { display: flex; }
        .modal-body { 
            background: #1a1a1a; color: #fff; width: 90%; max-width: 500px; 
            border-radius: 20px; padding: 35px; position: relative; border: 1px solid var(--gold);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .cart-item { 
            display: flex; 
            align-items: center;
            justify-content: space-between; 
            padding: 15px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        .cart-item.warning { background: rgba(192, 57, 43, 0.1); border-left: 3px solid var(--danger); padding-left: 10px; margin-left: -10px; }
        .cart-item.error { background: rgba(192, 57, 43, 0.2); border-left: 3px solid var(--danger); padding-left: 10px; margin-left: -10px; }
        
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: 600; color: #fff; margin-bottom: 4px; }
        .cart-item-details { font-size: 0.85rem; color: #aaa; }
        .cart-item-price { 
            color: var(--gold); 
            font-weight: 600; 
            margin-right: 15px;
            min-width: 80px;
            text-align: right;
        }
        
        .stock-warning {
            font-size: 0.75rem;
            color: var(--warning);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .stock-error {
            font-size: 0.75rem;
            color: var(--danger);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        
        .remove-btn {
            background: transparent;
            border: 1px solid #c0392b;
            color: #c0392b;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 1.1rem;
        }
        .remove-btn:hover {
            background: #c0392b;
            color: #fff;
            transform: scale(1.1);
        }
        
        .cart-qty-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .cart-qty-btn {
            width: 24px;
            height: 24px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        .cart-qty-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        .cart-qty-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .cart-qty-value {
            min-width: 24px;
            text-align: center;
            font-size: 0.9rem;
        }

        .total-box { 
            margin-top: 25px; 
            padding: 20px; 
            background: rgba(212, 175, 55, 0.1); 
            border-radius: 10px; 
            text-align: right; 
            font-size: 1.4rem; 
            color: var(--gold); 
            font-family: 'Playfair Display', serif; 
        }
        
        .validation-banner {
            background: linear-gradient(135deg, rgba(192, 57, 43, 0.9) 0%, rgba(231, 76, 60, 0.9) 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }
        .validation-banner.show { display: flex; }
        .validation-banner.warning {
            background: linear-gradient(135deg, rgba(230, 126, 34, 0.9) 0%, rgba(243, 156, 18, 0.9) 100%);
        }
        .validation-banner.success {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.9) 0%, rgba(46, 204, 113, 0.9) 100%);
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .wa-btn { 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            width: 100%; padding: 18px; margin-top: 25px; 
            background: #25D366; color: #fff; border: none; border-radius: 10px; 
            font-size: 1.1rem; font-weight: bold; cursor: pointer; 
            transition: filter 0.3s;
        }
        .wa-btn:hover { filter: brightness(1.1); }
        .wa-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .close-x { position: absolute; top: 20px; right: 25px; font-size: 2rem; cursor: pointer; color: #888; }
        .close-x:hover { color: var(--gold); }
        
        .notify { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--gold); 
            color: #000; 
            padding: 12px 30px; 
            border-radius: 30px; 
            font-weight: 600; 
            z-index: 9999; 
            display: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .clear-cart-btn {
            background: transparent;
            border: 1px solid #888;
            color: #888;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 15px;
            transition: all 0.3s;
        }
        .clear-cart-btn:hover {
            border-color: #c0392b;
            color: #c0392b;
        }
        
        .empty-cart-msg {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        .empty-cart-msg svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: var(--gold);
        }
        .error-msg {
            text-align: center;
            padding: 40px;
            color: #c0392b;
            background: rgba(192, 57, 43, 0.1);
            border-radius: 10px;
            margin: 20px;
        }
        
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--gold);
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 999;
        }
        .refresh-indicator.show { display: flex; }
        .refresh-indicator.syncing { color: #fff; }
    </style>
</head>
<body>

    <div class="refresh-indicator" id="refreshIndicator">
        <span id="refreshIcon">üîÑ</span>
        <span id="refreshText">Updating stock...</span>
    </div>

    <div class="container">
        <header>
            <h1>üê∫Karilaüê∫</h1>
            <p>Karila, Taste That Thrilla</p>
            <div class="sync-status" id="syncStatus" onclick="forceRefresh()">
                <div class="dot" id="syncDot"></div>
                <span id="syncText">Live Stock</span>
            </div>
            <div class="last-updated" id="lastUpdated"></div>
        </header>
        
        <div id="loadingState" class="loading">Memuat menu...</div>
        <div id="errorState" class="error-msg" style="display: none;"></div>
        <div class="menu-grid" id="menuGrid" style="display: none;"></div>
    </div>

    <div class="cart-trigger" id="cartOpen">üõí<div class="count-pill" id="cartCount">0</div></div>

    <div class="modal" id="cartModal">
        <div class="modal-body">
            <span class="close-x" id="cartClose">&times;</span>
            <h2 style="margin-bottom: 20px; font-family: 'Playfair Display'; color: var(--gold);">Your Selection</h2>
            
            <div class="validation-banner" id="validationBanner">
                <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
                <span id="validationText"></span>
            </div>
            
            <div id="cartItemsList"></div>

            <div class="name-field">
                <label>Atas Nama:</label>
                <input type="text" id="customerName" placeholder="Contoh: Budi Santoso (nama yang tidak asli tidak akan diproses)" required>
            </div>

            <div class="total-box" id="cartTotal"></div>
            <button class="wa-btn" id="waSend">Konfirmasi Pesanan via WhatsApp</button>
        </div>
    </div>

    <div id="notify" class="notify"></div>

    <script>
        // ============================================
        // CONFIG: REPLACE THIS WITH YOUR GOOGLE SHEET URL
        // ============================================
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpF3KDjN_dEBcNoYBve7zBxZOou6xHfTV2hT4E6wAfwgEUVeZ_fnLP0vJ6AjycCG3Evw6rxrGTgenc/pub?output=csv';
        
        const MY_PHONE = "6282311981783"; 
        const CART_STORAGE_KEY = 'karlia_cart';
        const REFRESH_INTERVAL = 10000; // 10 seconds
        let menuItems = [], quantities = {}, currencySymbol = "Rp", lastFetchTime = null;
        let cart = [];
        let isCartOpen = false;
        let stockValidationResults = { valid: true, issues: [] };

        // Parse CSV to JSON
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const currentline = lines[i].split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                const obj = {};
                headers.forEach((header, index) => {
                    let value = currentline[index] || '';
                    if (['id', 'price', 'stock', 'discount'].includes(header)) {
                        value = parseInt(value) || 0;
                    }
                    obj[header] = value;
                });
                result.push(obj);
            }
            return result;
        }

        async function loadMenu(force = false) {
            const syncDot = document.getElementById('syncDot');
            const syncText = document.getElementById('syncText');
            const refreshIndicator = document.getElementById('refreshIndicator');
            
            if (!force) {
                syncDot.classList.add('syncing');
                syncText.textContent = 'Syncing...';
                refreshIndicator.classList.add('show', 'syncing');
            }
            
            try {
                const url = GOOGLE_SHEET_URL + '&t=' + Date.now();
                const response = await fetch(url);
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const csvText = await response.text();
                const data = parseCSV(csvText);
                
                const oldMenuItems = [...menuItems];
                menuItems = data.filter(item => item.id);
                currencySymbol = "Rp";
                
                // Check for stock changes that affect cart
                if (oldMenuItems.length > 0 && isCartOpen) {
                    validateCartStock(true);
                }
                
                // Update quantities for new items
                menuItems.forEach(item => {
                    if (!quantities[item.id]) quantities[item.id] = 1;
                });
                
                lastFetchTime = new Date();
                updateLastUpdated();
                renderUI();
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('menuGrid').style.display = 'grid';
                
                syncDot.classList.remove('error');
                
            } catch (error) {
                console.error('Error loading menu:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorState').innerHTML = `
                    <strong>Gagal memuat menu</strong><br>
                    Cek koneksi internet atau refresh halaman.<br>
                    <small>${error.message}</small>
                `;
                syncDot.classList.add('error');
            } finally {
                syncDot.classList.remove('syncing');
                syncText.textContent = 'Live Stock';
                setTimeout(() => refreshIndicator.classList.remove('show', 'syncing'), 500);
            }
        }

        function updateLastUpdated() {
            if (lastFetchTime) {
                const timeStr = lastFetchTime.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('lastUpdated').textContent = `Terakhir update: ${timeStr}`;
            }
        }

        function forceRefresh() {
            loadMenu(true);
            flashNotify('Refreshing stock...');
        }

        // Auto refresh every 10 seconds
        setInterval(() => loadMenu(false), REFRESH_INTERVAL);

        function validateCartStock(silent = false) {
            stockValidationResults = { valid: true, issues: [] };
            let hasChanges = false;
            
            cart.forEach(cartItem => {
                const currentItem = menuItems.find(m => m.id === cartItem.id);
                
                if (!currentItem) {
                    // Item no longer exists
                    stockValidationResults.issues.push({
                        type: 'removed',
                        item: cartItem,
                        message: `${cartItem.name} sudah tidak tersedia`
                    });
                    stockValidationResults.valid = false;
                    hasChanges = true;
                } else if (currentItem.stock <= 0) {
                    // Item out of stock
                    stockValidationResults.issues.push({
                        type: 'outofstock',
                        item: cartItem,
                        currentStock: 0,
                        message: `${cartItem.name} habis (stok: 0)`
                    });
                    stockValidationResults.valid = false;
                    hasChanges = true;
                } else if (cartItem.quantity > currentItem.stock) {
                    // Quantity exceeds stock
                    stockValidationResults.issues.push({
                        type: 'exceeds',
                        item: cartItem,
                        requested: cartItem.quantity,
                        currentStock: currentItem.stock,
                        message: `${cartItem.name} melebihi stok (minta: ${cartItem.quantity}, tersedia: ${currentItem.stock})`
                    });
                    cartItem.quantity = currentItem.stock; // Auto-adjust
                    stockValidationResults.valid = false;
                    hasChanges = true;
                }
            });
            
            if (hasChanges && !silent) {
                saveCartToStorage();
                updateCartCounter();
                renderCartModal();
                showValidationBanner();
            }
            
            return stockValidationResults.valid;
        }

        function showValidationBanner() {
            const banner = document.getElementById('validationBanner');
            const text = document.getElementById('validationText');
            
            if (stockValidationResults.issues.length === 0) return;
            
            const critical = stockValidationResults.issues.filter(i => i.type === 'removed' || i.type === 'outofstock');
            const adjusted = stockValidationResults.issues.filter(i => i.type === 'exceeds');
            
            if (critical.length > 0) {
                banner.className = 'validation-banner show';
                text.innerHTML = `<strong>${critical.length} item tidak tersedia</strong> dan telah dihapus dari keranjang. Stok habis saat Anda memesan.`;
                // Remove invalid items
                const invalidIds = critical.map(i => i.item.id);
                cart = cart.filter(c => !invalidIds.includes(c.id));
                saveCartToStorage();
                updateCartCounter();
            } else if (adjusted.length > 0) {
                banner.className = 'validation-banner warning show';
                text.innerHTML = `<strong>Stok berubah!</strong> ${adjusted.length} item quantity disesuaikan dengan ketersediaan terbaru.`;
            }
            
            setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
        }

        function renderUI() {
            const grid = document.getElementById('menuGrid');
            grid.innerHTML = '';
            
            menuItems.forEach(item => {
                const finalPrice = item.discount > 0 ? item.price * (1 - item.discount/100) : item.price;
                const isOut = item.stock <= 0;
                const isLow = item.stock > 0 && item.stock <= 5;
                
                // Check if this item is in cart and exceeds stock
                const inCart = cart.find(c => c.id === item.id);
                const cartExceeds = inCart && inCart.quantity > item.stock;
                
                grid.innerHTML += `
                    <div class="menu-item ${isOut ? 'out-of-stock' : ''} ${cartExceeds ? 'stock-changed' : ''}">
                        <div class="item-image">
                            <img src="${item.image || 'https://placehold.co/400x300/333/d4af37?text=' + encodeURIComponent(item.name)}" 
                                 onerror="this.src='https://placehold.co/400x300/333/d4af37?text=${encodeURIComponent(item.name)}'">
                            ${item.discount > 0 ? `<div class="discount-badge">-${item.discount}%</div>` : ''}
                            <div class="stock-badge ${isLow ? 'low' : ''} ${cartExceeds ? 'error' : ''}">
                                ${isOut ? 'Sold Out' : `Stok: ${item.stock}${isLow ? ' ‚ö†Ô∏è' : ''}${cartExceeds ? ' ‚ùå' : ''}`}
                            </div>
                        </div>
                        <div class="item-content">
                            <div class="item-name">${item.name}</div>
                            <p class="item-desc">${item.description || ''}</p>
                            <div class="price-row">
                                <span class="now-price">${currencySymbol}${finalPrice.toLocaleString('id-ID')}</span>
                                ${item.discount > 0 ? `<span style="text-decoration: line-through; color: #888; font-size: 0.9rem;">${currencySymbol}${item.price.toLocaleString('id-ID')}</span>` : ''}
                            </div>
                            <div class="qty-box">
                                <button class="qty-btn" onclick="changeQty(${item.id}, -1)" ${isOut ? 'disabled' : ''}>‚àí</button>
                                <span id="qty-val-${item.id}" style="font-weight:bold">${quantities[item.id]}</span>
                                <button class="qty-btn" onclick="changeQty(${item.id}, 1)" ${isOut ? 'disabled' : ''}>+</button>
                            </div>
                            <button class="buy-btn" onclick="addToCart(${item.id})" ${isOut ? 'disabled' : ''}>
                                ${isOut ? 'Habis' : 'Tambah Pesanan'}
                            </button>
                        </div>
                    </div>`;
            });
        }

        function changeQty(id, delta) {
            const item = menuItems.find(i => i.id === id);
            if (!item) return;
            const next = quantities[id] + delta;
            if (next >= 1 && next <= item.stock) {
                quantities[id] = next;
                document.getElementById(`qty-val-${id}`).innerText = next;
            }
        }

        function addToCart(id) {
            const item = menuItems.find(i => i.id === id);
            if (!item) return;
            
            if (item.stock <= 0) {
                flashNotify("Maaf, stok habis!");
                return;
            }
            
            const existing = cart.find(c => c.id === id);
            if (existing) {
                const newQty = existing.quantity + quantities[id];
                if (newQty > item.stock) {
                    flashNotify(`Stok tidak cukup! Tersedia: ${item.stock}, di keranjang: ${existing.quantity}`);
                    return;
                }
                existing.quantity = newQty;
            } else {
                cart.push({ 
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    discount: item.discount || 0,
                    image: item.image,
                    quantity: Math.min(quantities[id], item.stock)
                });
            }
            saveCartToStorage();
            updateCartCounter();
            flashNotify("Ditambahkan ke keranjang");
        }

        function updateCartCounter() {
            document.getElementById('cartCount').innerText = cart.reduce((acc, i) => acc + i.quantity, 0);
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            saveCartToStorage();
            updateCartCounter();
            renderCartModal();
            flashNotify("Item dihapus dari keranjang");
        }

        function updateCartQuantity(id, delta) {
            const item = cart.find(c => c.id === id);
            const menuItem = menuItems.find(m => m.id === id);
            
            if (!item || !menuItem) return;
            
            const newQty = item.quantity + delta;
            
            if (newQty <= 0) {
                removeFromCart(id);
                return;
            }
            
            if (newQty > menuItem.stock) {
                flashNotify(`Stok hanya tersedia ${menuItem.stock}`);
                return;
            }
            
            item.quantity = newQty;
            saveCartToStorage();
            updateCartCounter();
            renderCartModal();
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (confirm("Yakin ingin mengosongkan keranjang?")) {
                cart = [];
                saveCartToStorage();
                updateCartCounter();
                renderCartModal();
                flashNotify("Keranjang dikosongkan");
            }
        }

        function renderCartModal() {
            const list = document.getElementById('cartItemsList');
            let grandTotal = 0;
            
            if (cart.length === 0) {
                list.innerHTML = `
                    <div class="empty-cart-msg">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <p>Keranjang kosong.</p>
                        <p style="font-size: 0.85rem; margin-top: 10px;">Silakan pilih menu favorit Anda</p>
                    </div>`;
            } else {
                list.innerHTML = '';
                cart.forEach(item => {
                    const currentItem = menuItems.find(m => m.id === item.id);
                    const price = item.discount > 0 ? item.price * (1 - item.discount/100) : item.price;
                    const itemTotal = price * item.quantity;
                    grandTotal += itemTotal;
                    
                    let stockStatusHtml = '';
                    let itemClass = 'cart-item';
                    
                    if (!currentItem) {
                        itemClass += ' error';
                        stockStatusHtml = `<div class="stock-error">‚ùå Item tidak tersedia lagi</div>`;
                    } else if (currentItem.stock <= 0) {
                        itemClass += ' error';
                        stockStatusHtml = `<div class="stock-error">‚ùå Stok habis</div>`;
                    } else if (item.quantity > currentItem.stock) {
                        itemClass += ' warning';
                        stockStatusHtml = `<div class="stock-warning">‚ö†Ô∏è Stok tersisa: ${currentItem.stock}</div>`;
                    } else if (currentItem.stock <= 5) {
                        stockStatusHtml = `<div class="stock-warning">‚ö†Ô∏è Stok menipis: ${currentItem.stock}</div>`;
                    }
                    
                    list.innerHTML += `
                        <div class="${itemClass}">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-details">
                                    ${currencySymbol}${price.toLocaleString('id-ID')} / item
                                </div>
                                ${stockStatusHtml}
                                <div class="cart-qty-control">
                                    <button class="cart-qty-btn" onclick="updateCartQuantity(${item.id}, -1)" ${!currentItem || currentItem.stock <= 0 ? 'disabled' : ''}>‚àí</button>
                                    <span class="cart-qty-value">${item.quantity}</span>
                                    <button class="cart-qty-btn" onclick="updateCartQuantity(${item.id}, 1)" ${!currentItem || item.quantity >= currentItem.stock ? 'disabled' : ''}>+</button>
                                </div>
                            </div>
                            <div class="cart-item-price">${currencySymbol}${itemTotal.toLocaleString('id-ID')}</div>
                            <button class="remove-btn" onclick="removeFromCart(${item.id})" title="Hapus item">
                                √ó
                            </button>
                        </div>`;
                });
                
                list.innerHTML += `
                    <div style="text-align: center;">
                        <button class="clear-cart-btn" onclick="clearCart()">üóëÔ∏è Kosongkan Keranjang</button>
                    </div>`;
            }
            
            document.getElementById('cartTotal').innerText = `Total: ${currencySymbol}${grandTotal.toLocaleString('id-ID')}`;
            
            const waBtn = document.getElementById('waSend');
            waBtn.disabled = cart.length === 0 || !stockValidationResults.valid;
        }

        function sendToWA() {
            // Final validation before sending
            const isValid = validateCartStock();
            if (!isValid) {
                flashNotify("Periksa keranjang - ada perubahan stok!");
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();
            if (!name) return alert("Harap isi 'Atas Nama' terlebih dahulu!");
            if (cart.length === 0) return alert("Keranjang masih kosong!");

            let msg = `*PESANAN BARU - KARLIA* üê∫\n--------------------------\n*Atas Nama:* ${name}\n--------------------------\n`;
            let total = 0;
            cart.forEach(item => {
                const p = item.discount > 0 ? item.price * (1 - item.discount/100) : item.price;
                total += p * item.quantity;
                msg += `‚Ä¢ *${item.name}* (x${item.quantity})\n`;
            });
            msg += `\n--------------------------\n*TOTAL: ${currencySymbol}${total.toLocaleString('id-ID')}*`;
            
            cart = [];
            saveCartToStorage();
            updateCartCounter();
            
            window.open(`https://wa.me/${MY_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
            document.getElementById('cartModal').classList.remove('open');
            document.getElementById('validationBanner').classList.remove('show');
        }

        function flashNotify(m) {
            const n = document.getElementById('notify');
            n.innerText = m; 
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 2000);
        }

        // Cart persistence
        function loadCartFromStorage() {
            try {
                const savedCart = localStorage.getItem(CART_STORAGE_KEY);
                if (savedCart) {
                    cart = JSON.parse(savedCart);
                    updateCartCounter();
                }
            } catch (e) {
                console.error('Error loading cart:', e);
                cart = [];
            }
        }

        function saveCartToStorage() {
            try {
                localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            } catch (e) {
                console.error('Error saving cart:', e);
            }
        }

        // Event listeners
        document.getElementById('cartOpen').onclick = () => { 
            isCartOpen = true;
            validateCartStock(); // Validate when opening
            document.getElementById('cartModal').classList.add('open'); 
            renderCartModal(); 
        };
        
        document.getElementById('cartClose').onclick = () => {
            isCartOpen = false;
            document.getElementById('cartModal').classList.remove('open');
            document.getElementById('validationBanner').classList.remove('show');
        };
        
        document.getElementById('waSend').onclick = sendToWA;

        document.getElementById('cartModal').onclick = (e) => {
            if (e.target.id === 'cartModal') {
                isCartOpen = false;
                document.getElementById('cartModal').classList.remove('open');
                document.getElementById('validationBanner').classList.remove('show');
            }
        };

        // Initialize
        loadCartFromStorage();
        loadMenu();
    </script>
</body>
</html>
